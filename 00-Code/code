
// ==================== Ø³ÛŒØ³ØªÙ… Ú©Ø§Ù…Ù„ Ù†ÙˆØ¨Øª Ù†Ùˆ ====================

// Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„
function create_nobat_tables() {
    global $wpdb;
    
    $table_name = $wpdb->prefix . 'nobat_system';
    if($wpdb->get_var("SHOW TABLES LIKE '$table_name'") != $table_name) {
        $sql = "CREATE TABLE $table_name (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            patient_name varchar(100) NOT NULL,
            phone_number varchar(20) NOT NULL,
            status varchar(20) DEFAULT 'pending',
            position int(11) DEFAULT 0,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id)
        ) {$wpdb->get_charset_collate()};";
        
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql);
    }
    
    $users_table = $wpdb->prefix . 'nobat_users';
    if($wpdb->get_var("SHOW TABLES LIKE '$users_table'") != $users_table) {
        $sql = "CREATE TABLE $users_table (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            full_name varchar(100) NOT NULL,
            phone_number varchar(20) NOT NULL,
            password varchar(255) NOT NULL,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY phone_number (phone_number)
        ) {$wpdb->get_charset_collate()};";
        
        dbDelta($sql);
    }
}

register_activation_hook(__FILE__, 'create_nobat_tables');

function start_nobat_session() {
    if (!session_id()) {
        session_start();
    }
}
add_action('init', 'start_nobat_session');

// ==================== Ø´ÙˆØ±Øªâ€ŒÚ©Ø¯Ù‡Ø§ ====================

function nobat_panel_shortcode() {
    create_nobat_tables();
    ob_start();
    ?>
    <div dir="rtl" style="max-width: 800px; margin: 20px auto; padding: 20px; font-family: Tahoma;">
        <div style="background: #e8f4ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="margin-top: 0;">Ø§ÙØ²ÙˆØ¯Ù† Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯</h3>
            <form id="nobat-form">
                <input type="text" name="patient_name" placeholder="Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±" required 
                       style="padding: 10px; margin: 5px; width: 200px; border: 1px solid #ddd; border-radius: 5px;">
                <input type="tel" name="phone_number" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ (11 Ø±Ù‚Ù…)" required
                       pattern="[0-9]{11}" style="padding: 10px; margin: 5px; width: 200px; border: 1px solid #ddd; border-radius: 5px;"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                <button type="submit" style="padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Ø«Ø¨Øª Ù†ÙˆØ¨Øª
                </button>
            </form>
        </div>

        <div style="background: #f9f9f9; padding: 20px; border-radius: 10px;">
            <h3 style="margin-top: 0;">Ù„ÛŒØ³Øª Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</h3>
            <div id="nobat-list">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        </div>
    </div>

    <script>
    jQuery(document).ready(function($) {
        function loadNobat() {
            $.get('<?php echo admin_url('admin-ajax.php'); ?>?action=get_nobat_list', function(response) {
                $('#nobat-list').html(response);
            });
        }

        $('#nobat-form').submit(function(e) {
            e.preventDefault();
            var phone = $('input[name="phone_number"]').val();
            if (phone.length !== 11 || !/^\d+$/.test(phone)) {
                alert('Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯');
                return false;
            }
            $.post('<?php echo admin_url('admin-ajax.php'); ?>?action=add_nobat', $(this).serialize(), function(response) {
                alert(response);
                loadNobat();
                $('#nobat-form')[0].reset();
            });
        });

        loadNobat();
        setInterval(loadNobat, 5000);
    });

    function changeNobatStatus(id, status) {
        jQuery.post('<?php echo admin_url('admin-ajax.php'); ?>?action=change_nobat_status', {
            id: id, status: status
        }, function(response) {
            alert(response);
            location.reload();
        });
    }

    function cancelAppointment(id) {
        if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ù„ØºÙˆ Ø§ÛŒÙ† Ù†ÙˆØ¨Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
            jQuery.post('<?php echo admin_url('admin-ajax.php'); ?>?action=cancel_appointment', {
                id: id
            }, function(response) {
                alert(response);
                location.reload();
            });
        }
    }
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('nobat_panel', 'nobat_panel_shortcode');

function nobat_status_shortcode() {
    ob_start();
    ?>
    <div dir="rtl" style="max-width: 600px; margin: 20px auto; padding: 20px; text-align: center; font-family: Tahoma;">
        <h2 style="color: #28a745; margin-top: 0;">Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù†ÙˆØ¨Øª Ø´Ù…Ø§</h2>
        <form id="check-nobat-form" style="margin: 20px 0;">
            <input type="tel" name="phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ (11 Ø±Ù‚Ù…)" required
                   pattern="[0-9]{11}" style="padding: 12px; width: 250px; border: 1px solid #ddd; border-radius: 5px; margin: 10px;"
                   oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            <br>
            <button type="submit" style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px;">
                Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
            </button>
        </form>
        <div id="nobat-result" style="margin-top: 20px; padding: 20px; border-radius: 10px; background: #f8f9fa;"></div>
    </div>

    <script>
    jQuery(document).ready(function($) {
        $('#check-nobat-form').submit(function(e) {
            e.preventDefault();
            var phone = $('input[name="phone"]').val();
            if (phone.length !== 11 || !/^\d+$/.test(phone)) {
                alert('Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯');
                return false;
            }
            $('#nobat-result').html('<div style="padding: 20px;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</div>');
            $.get('<?php echo admin_url('admin-ajax.php'); ?>?action=check_nobat_status&phone=' + phone, function(response) {
                $('#nobat-result').html(response);
            });
        });
    });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('nobat_status', 'nobat_status_shortcode');

function nobat_register_shortcode() {
    ob_start();
    ?>
    <div dir="rtl" style="max-width: 400px; margin: 20px auto; padding: 20px; font-family: Tahoma;">
        <h2 style="color: #007cba; text-align: center; margin-top: 0;">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø± Ù†ÙˆØ¨Øª Ù†Ùˆ</h2>
        <form id="register-form" style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <div style="margin-bottom: 15px;">
                <input type="text" name="full_name" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required 
                       style="padding: 12px; width: 100%; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 15px;">
                <input type="tel" name="phone_number" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ (11 Ø±Ù‚Ù…)" required
                       pattern="[0-9]{11}" style="padding: 12px; width: 100%; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <div style="margin-bottom: 20px; position: relative;">
                <input type="password" name="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required
                       style="padding: 12px; width: 100%; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; padding-right: 40px;"
                       id="register-password">
                <span toggle="#register-password" class="toggle-password" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 18px;">ğŸ‘ï¸</span>
            </div>
            <button type="submit" style="padding: 12px 30px; background: #007cba; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
            </button>
        </form>
        <div id="register-result" style="margin-top: 15px;"></div>
        <div style="text-align: center; margin-top: 20px;">
            <p>Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ <a href="/ÙˆØ±ÙˆØ¯/" style="color: #007cba;">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a></p>
        </div>
    </div>

    <script>
    jQuery(document).ready(function($) {
        $('.toggle-password').click(function() {
            var input = $($(this).attr('toggle'));
            if (input.attr('type') == 'password') {
                input.attr('type', 'text');
            } else {
                input.attr('type', 'password');
            }
        });

        $('#register-form').submit(function(e) {
            e.preventDefault();
            var phone = $('input[name="phone_number"]').val();
            var password = $('input[name="password"]').val();
            if (phone.length !== 11 || !/^\d+$/.test(phone)) {
                alert('Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯');
                return false;
            }
            if (password.length < 4) {
                alert('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 4 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯');
                return false;
            }
            $('#register-result').html('<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...</div>');
            $.post('<?php echo admin_url('admin-ajax.php'); ?>?action=register_user', $(this).serialize(), function(response) {
                if (response.success) {
                    window.location.href = '/Ù¾Ù†Ù„-Ú©Ø§Ø±Ø¨Ø±ÛŒ/';
                } else {
                    $('#register-result').html(response.data);
                }
            });
        });
    });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('nobat_register', 'nobat_register_shortcode');

function nobat_login_shortcode() {
    ob_start();
    ?>
    <div dir="rtl" style="max-width: 400px; margin: 20px auto; padding: 20px; font-family: Tahoma;">
        <h2 style="color: #007cba; text-align: center; margin-top: 0;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù†ÙˆØ¨Øª Ù†Ùˆ</h2>
        <form id="login-form" style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <div style="margin-bottom: 15px;">
                <input type="tel" name="phone_number" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ (11 Ø±Ù‚Ù…)" required
                       pattern="[0-9]{11}" style="padding: 12px; width: 100%; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <div style="margin-bottom: 20px; position: relative;">
                <input type="password" name="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required
                       style="padding: 12px; width: 100%; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; padding-right: 40px;"
                       id="login-password">
                <span toggle="#login-password" class="toggle-password" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 18px;">ğŸ‘ï¸</span>
            </div>
            <button type="submit" style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                ÙˆØ±ÙˆØ¯
            </button>
        </form>
        <div id="login-result" style="margin-top: 15px;"></div>
        <div style="text-align: center; margin-top: 20px;">
            <p>Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="/Ø«Ø¨Øª-Ù†Ø§Ù…/" style="color: #007cba;">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯</a></p>
        </div>
    </div>

    <script>
    jQuery(document).ready(function($) {
        $('.toggle-password').click(function() {
            var input = $($(this).attr('toggle'));
            if (input.attr('type') == 'password') {
                input.attr('type', 'text');
            } else {
                input.attr('type', 'password');
            }
        });

        $('#login-form').submit(function(e) {
            e.preventDefault();
            var phone = $('input[name="phone_number"]').val();
            if (phone.length !== 11 || !/^\d+$/.test(phone)) {
                alert('Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯');
                return false;
            }
            $('#login-result').html('<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...</div>');
            $.post('<?php echo admin_url('admin-ajax.php'); ?>?action=login_user', $(this).serialize(), function(response) {
                if (response.success) {
                    window.location.href = '/Ù¾Ù†Ù„-Ú©Ø§Ø±Ø¨Ø±ÛŒ/';
                } else {
                    $('#login-result').html(response.data);
                }
            });
        });
    });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('nobat_login', 'nobat_login_shortcode');

function nobat_dashboard_shortcode() {
    if (!isset($_SESSION['nobat_user'])) {
        return "<div style='text-align: center; padding: 40px;'>
                    <h3>Ù„Ø·ÙØ§Ù‹ Ø§ÙˆÙ„ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</h3>
                    <a href='/ÙˆØ±ÙˆØ¯/' style='padding: 10px 20px; background: #007cba; color: white; text-decoration: none; border-radius: 5px;'>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</a>
                </div>";
    }
    
    $user = $_SESSION['nobat_user'];
    ob_start();
    ?>
    <div dir="rtl" style="max-width: 800px; margin: 20px auto; padding: 20px; font-family: Tahoma;">
        <div style="background: linear-gradient(135deg, #007cba, #005a87); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 24px;">Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†ÙˆØ¨Øª Ù†Ùˆ</h2>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ <?php echo $user['full_name']; ?></p>
        </div>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #007cba;">ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div><strong>Ù†Ø§Ù… Ú©Ø§Ù…Ù„:</strong><br><?php echo $user['full_name']; ?></div>
                <div><strong>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</strong><br><?php echo $user['phone_number']; ?></div>
            </div>
        </div>

        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #856404;">ğŸ“… Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± Ø´Ù…Ø§</h3>
            <div id="user-appointments">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <a href="/ÙˆØ¶Ø¹ÛŒØª-Ù†ÙˆØ¨Øª/" style="background: #28a745; color: white; padding: 15px; text-align: center; border-radius: 8px; text-decoration: none;">
                ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù†ÙˆØ¨Øª
            </a>
            <a href="/Ø¯Ø±ÛŒØ§ÙØª-Ù†ÙˆØ¨Øª/" style="background: #007cba; color: white; padding: 15px; text-align: center; border-radius: 8px; text-decoration: none;">
                ğŸ“ Ø¯Ø±ÛŒØ§ÙØª Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯
            </a>
        </div>

        <div style="text-align: center;">
            <button onclick="logoutUser()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ
            </button>
        </div>
    </div>

    <script>
    function logoutUser() {
        if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) {
            window.location.href = '<?php echo admin_url('admin-ajax.php'); ?>?action=logout_user';
        }
    }

    jQuery(document).ready(function($) {
        function loadUserAppointments() {
            $.get('<?php echo admin_url('admin-ajax.php'); ?>?action=get_user_appointments', function(response) {
                $('#user-appointments').html(response);
            });
        }
        loadUserAppointments();
    });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('nobat_dashboard', 'nobat_dashboard_shortcode');

function nobat_new_appointment_shortcode() {
    if (!isset($_SESSION['nobat_user'])) {
        return "<div style='text-align: center; padding: 40px;'>
                    <h3>Ù„Ø·ÙØ§Ù‹ Ø§ÙˆÙ„ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</h3>
                    <a href='/ÙˆØ±ÙˆØ¯/' style='padding: 10px 20px; background: #007cba; color: white; text-decoration: none; border-radius: 5px;'>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</a>
                </div>";
    }
    
    $user = $_SESSION['nobat_user'];
    ob_start();
    ?>
    <div dir="rtl" style="max-width: 800px; margin: 20px auto; padding: 20px; font-family: Tahoma;">
        <h2 style="color: #007cba; text-align: center; margin-top: 0;">Ø¯Ø±ÛŒØ§ÙØª Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯</h2>
        
        <div style="background: #e8f4ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="margin-top: 0;">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±</h3>
            <p><strong>Ù†Ø§Ù…:</strong> <?php echo $user['full_name']; ?></p>
            <p><strong>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</strong> <?php echo $user['phone_number']; ?></p>
        </div>

        <div style="background: #f9f9f9; padding: 20px; border-radius: 10px;">
            <h3 style="margin-top: 0;">ğŸ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¨Øª</h3>
            <form id="new-appointment-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø²Ø´Ú©:</label>
                    <select name="doctor" required style="padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                        <option value="Ø¯Ú©ØªØ± Ø§Ø­Ù…Ø¯ÛŒ">Ø¯Ú©ØªØ± Ø§Ø­Ù…Ø¯ÛŒ - Ù…ØªØ®ØµØµ Ù‚Ù„Ø¨</option>
                        <option value="Ø¯Ú©ØªØ± Ù…Ø­Ù…Ø¯ÛŒ">Ø¯Ú©ØªØ± Ù…Ø­Ù…Ø¯ÛŒ - Ù…ØªØ®ØµØµ Ù…ØºØ² Ùˆ Ø§Ø¹ØµØ§Ø¨</option>
                        <option value="Ø¯Ú©ØªØ± Ø±Ø¶Ø§ÛŒÛŒ">Ø¯Ú©ØªØ± Ø±Ø¶Ø§ÛŒÛŒ - Ù…ØªØ®ØµØµ Ù¾ÙˆØ³Øª</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ù†ÙˆØ¹ ÙˆÛŒØ²ÛŒØª:</label>
                    <select name="service" required style="padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                        <option value="ÙˆÛŒØ²ÛŒØª Ø¹Ø§Ø¯ÛŒ">ÙˆÛŒØ²ÛŒØª Ø¹Ø§Ø¯ÛŒ</option>
                        <option value="ÙˆÛŒØ²ÛŒØª ÙˆÛŒÚ˜Ù‡">ÙˆÛŒØ²ÛŒØª ÙˆÛŒÚ˜Ù‡</option>
                        <option value="Ù…Ø´Ø§ÙˆØ±Ù‡">Ù…Ø´Ø§ÙˆØ±Ù‡</option>
                    </select>
                </div>
                
                <button type="submit" style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                    ğŸ“… Ø«Ø¨Øª Ù†ÙˆØ¨Øª
                </button>
            </form>
            
            <div id="appointment-result" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
    jQuery(document).ready(function($) {
        $('#new-appointment-form').submit(function(e) {
            e.preventDefault();
            
            $('#appointment-result').html('<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ù†ÙˆØ¨Øª...</div>');
            
            $.post('<?php echo admin_url('admin-ajax.php'); ?>?action=add_user_appointment', $(this).serialize(), function(response) {
                $('#appointment-result').html(response);
                if (response.includes('Ù…ÙˆÙÙ‚ÛŒØª')) {
                    setTimeout(function() {
                        window.location.href = '/Ù¾Ù†Ù„-Ú©Ø§Ø±Ø¨Ø±ÛŒ/';
                    }, 2000);
                }
            });
        });
    });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('nobat_new_appointment', 'nobat_new_appointment_shortcode');

// ==================== ØªÙˆØ§Ø¨Ø¹ Ajax ====================

function add_nobat_ajax() {
    global $wpdb;
    
    $name = sanitize_text_field($_POST['patient_name']);
    $phone = sanitize_text_field($_POST['phone_number']);
    $table_name = $wpdb->prefix . 'nobat_system';
    
    if (strlen($phone) !== 11 || !preg_match('/^\d+$/', $phone)) {
        echo "Ø®Ø·Ø§: Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯";
        wp_die();
    }
    
    create_nobat_tables();
    
    $last_pos = $wpdb->get_var("SELECT MAX(position) FROM $table_name");
    $new_pos = $last_pos ? $last_pos + 1 : 1;
    
    $result = $wpdb->insert($table_name, array(
        'patient_name' => $name,
        'phone_number' => $phone,
        'status' => 'pending',
        'position' => $new_pos
    ), array('%s', '%s', '%s', '%d'));
    
    if ($result) {
        echo "Ù†ÙˆØ¨Øª Ø¨Ø±Ø§ÛŒ {$name} Ø«Ø¨Øª Ø´Ø¯! Ø´Ù…Ø§Ø±Ù‡ Ù†ÙˆØ¨Øª: {$new_pos}";
    } else {
        echo "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†ÙˆØ¨Øª!";
    }
    
    wp_die();
}

function get_nobat_list_ajax() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'nobat_system';
    
    create_nobat_tables();
    
    $nobats = $wpdb->get_results("SELECT * FROM $table_name WHERE status != 'cancelled' ORDER BY position ASC");
    
    if ($nobats && count($nobats) > 0) {
        $output = '<div style="display: grid; gap: 10px;">';
        foreach ($nobats as $nobat) {
            $status_color = $nobat->status == 'pending' ? '#ffc107' : 
                           ($nobat->status == 'in-progress' ? '#007cba' : 
                           ($nobat->status == 'completed' ? '#28a745' : '#dc3545'));
            $status_text = $nobat->status == 'pending' ? 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±' : 
                          ($nobat->status == 'in-progress' ? 'Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ²ÛŒØª' : 
                          ($nobat->status == 'completed' ? 'Ø§ØªÙ…Ø§Ù… ÛŒØ§ÙØªÙ‡' : 'Ù„ØºÙˆ Ø´Ø¯Ù‡'));
            
            $output .= "
            <div style='border-right: 5px solid {$status_color}; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);'>
                <div style='display: flex; justify-content: space-between; align-items: center;'>
                    <div>
                        <strong>{$nobat->patient_name}</strong><br>
                        <small>{$nobat->phone_number}</small><br>
                        <small>Ø´Ù…Ø§Ø±Ù‡ Ù†ÙˆØ¨Øª: {$nobat->position}</small>
                    </div>
                    <div style='text-align: center;'>
                        <div>{$status_text}</div>
                        " . ($nobat->status == 'pending' ? "
                        <button onclick='changeNobatStatus({$nobat->id}, \"in-progress\")' style='padding: 8px 15px; margin: 2px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer;'>Ø´Ø±ÙˆØ¹ ÙˆÛŒØ²ÛŒØª</button>
                        <button onclick='cancelAppointment({$nobat->id})' style='padding: 8px 15px; margin: 2px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;'>Ù„ØºÙˆ Ù†ÙˆØ¨Øª</button>
                        " : "") . "
                        " . ($nobat->status == 'in-progress' ? "
                        <button onclick='changeNobatStatus({$nobat->id}, \"completed\")' style='padding: 8px 15px; margin: 2px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;'>Ø§ØªÙ…Ø§Ù… ÙˆÛŒØ²ÛŒØª</button>
                        <button onclick='cancelAppointment({$nobat->id})' style='padding: 8px 15px; margin: 2px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;'>Ù„ØºÙˆ Ù†ÙˆØ¨Øª</button>
                        " : "") . "
                    </div>
                </div>
            </div>";
        }
        $output .= '</div>';
    } else {
        $output = '<p style="text-align: center; color: #666;">Ù‡ÛŒÚ† Ù†ÙˆØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
    }
    
    echo $output;
    wp_die();
}

function check_nobat_status_ajax() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'nobat_system';
    
    $phone = sanitize_text_field($_GET['phone']);
    
    if (strlen($phone) !== 11 || !preg_match('/^\d+$/', $phone)) {
        echo "<div style='background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; border: 1px solid #ffeaa7;'>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯</div>";
        wp_die();
    }
    
    $nobat = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE phone_number = %s AND status != 'cancelled' ORDER BY id DESC LIMIT 1", $phone));
    
    if ($nobat) {
        $current_position = $nobat->position;
        $completed_count = $wpdb->get_var("SELECT COUNT(*) FROM $table_name WHERE status = 'completed'");
        $pending_before = $wpdb->get_var($wpdb->prepare("SELECT COUNT(*) FROM $table_name WHERE status = 'pending' AND position < %d", $current_position));
        $in_progress_count = $wpdb->get_var("SELECT COUNT(*) FROM $table_name WHERE status = 'in-progress'");
        
        $estimated_minutes = $pending_before * 15;
        $estimated_time = $estimated_minutes < 60 ? "Ø­Ø¯ÙˆØ¯ {$estimated_minutes} Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø±" : 
                         "Ø­Ø¯ÙˆØ¯ " . floor($estimated_minutes / 60) . " Ø³Ø§Ø¹Øª Ùˆ " . ($estimated_minutes % 60) . " Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø±";
        
        $status_text = $nobat->status == 'pending' ? 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±' : 
                      ($nobat->status == 'in-progress' ? 'Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ²ÛŒØª' : 'Ø§ØªÙ…Ø§Ù… ÛŒØ§ÙØªÙ‡');
        
        echo "
        <div style='background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 15px rgba(0,0,0,0.1);'>
            <h3 style='color: #007cba; margin-top: 0; border-bottom: 2px solid #007cba; padding-bottom: 10px;'>ÙˆØ¶Ø¹ÛŒØª Ù†ÙˆØ¨Øª Ø´Ù…Ø§</h3>
            
            <div style='font-size: 16px; line-height: 2.5; text-align: right;'>
                <div><strong>Ù†Ø§Ù…:</strong> {$nobat->patient_name}</div>
                <div><strong>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</strong> {$nobat->phone_number}</div>
                <div><strong>Ø´Ù…Ø§Ø±Ù‡ Ù†ÙˆØ¨Øª:</strong> {$nobat->position}</div>
                <div><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> 
                    <span style='color: " . ($nobat->status == 'pending' ? '#ffc107' : ($nobat->status == 'in-progress' ? '#007cba' : '#28a745')) . "; font-weight: bold;'>
                        {$status_text}
                    </span>
                </div>
            </div>
            
            <div style='margin-top: 25px; padding: 20px; background: #e8f4ff; border-radius: 8px; border-right: 4px solid #007cba;'>
                <h4 style='color: #007cba; margin-top: 0;'>ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØµÙ Ù†ÙˆØ¨Øª</h4>
                <div style='font-size: 14px; line-height: 2; text-align: right;'>
                    <div>âœ… <strong>ØªØ¹Ø¯Ø§Ø¯ Ø§ØªÙ…Ø§Ù… ÛŒØ§ÙØªÙ‡:</strong> {$completed_count} Ù†ÙˆØ¨Øª</div>
                    <div>â³ <strong>ØªØ¹Ø¯Ø§Ø¯ Ù‚Ø¨Ù„ Ø§Ø² Ø´Ù…Ø§:</strong> {$pending_before} Ù†ÙØ±</div>
                    <div>ğŸ‘¨â€âš•ï¸ <strong>Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ²ÛŒØª:</strong> {$in_progress_count} Ù†ÙØ±</div>
                    <div style='margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; border-right: 3px solid #ffc107;'>
                        â° <strong>Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÛŒØ¨ÛŒ:</strong> {$estimated_time}
                    </div>
                </div>
            </div>
        </div>";
    } else {
        echo "<div style='background: #fff3cd; color: #856404; padding: 20px; border-radius: 8px; border: 1px solid #ffeaa7; text-align: center;'>
                <h4 style='margin-top: 0;'>âŒ Ù†ÙˆØ¨ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h4>
                <p>Ù†ÙˆØ¨ØªÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</p>
              </div>";
    }
    
    wp_die();
}

function change_nobat_status_ajax() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'nobat_system';
    
    $id = intval($_POST['id']);
    $status = sanitize_text_field($_POST['status']);
    
    $wpdb->update($table_name, array('status' => $status), array('id' => $id), array('%s'), array('%d'));
    
    echo "ÙˆØ¶Ø¹ÛŒØª Ù†ÙˆØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!";
    wp_die();
}

function cancel_appointment_ajax() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'nobat_system';
    
    $id = intval($_POST['id']);
    
    // Ú†Ú© Ú©Ù† Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯ÛŒÙ† Ú©Ø±Ø¯Ù‡
    if (!isset($_SESSION['nobat_user'])) {
        echo "Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯";
        wp_die();
    }
    
    $user_phone = $_SESSION['nobat_user']['phone_number'];
    
    // Ú†Ú© Ú©Ù† Ø§ÛŒÙ† Ù†ÙˆØ¨Øª Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù‡Ø³Øª
    $appointment = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE id = %d", $id));
    
    if (!$appointment) {
        echo "Ù†ÙˆØ¨Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯";
        wp_die();
    }
    
    // Ø§Ú¯Ø± Ù†ÙˆØ¨Øª Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù†ÛŒØ³ØªØŒ Ø§Ø¬Ø§Ø²Ù‡ Ù„ØºÙˆ Ù†Ø¯Ù‡
    if ($appointment->phone_number !== $user_phone) {
        echo "Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ù„ØºÙˆ Ø§ÛŒÙ† Ù†ÙˆØ¨Øª Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯";
        wp_die();
    }
    
    // ÙÙ‚Ø· Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ pending Ù‚Ø§Ø¨Ù„ Ù„ØºÙˆ Ù‡Ø³ØªÙ†Ø¯
    if ($appointment->status !== 'pending') {
        echo "ÙÙ‚Ø· Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø§Ø¨Ù„ Ù„ØºÙˆ Ù‡Ø³ØªÙ†Ø¯";
        wp_die();
    }
    
    $result = $wpdb->update($table_name, array('status' => 'cancelled'), array('id' => $id), array('%s'), array('%d'));
    
    if ($result) {
        echo "Ù†ÙˆØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯!";
    } else {
        echo "Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù†ÙˆØ¨Øª!";
    }
    
    wp_die();
}

function register_user_ajax() {
    global $wpdb;
    
    $full_name = sanitize_text_field($_POST['full_name']);
    $phone = sanitize_text_field($_POST['phone_number']);
    $password = $_POST['password'];
    
    if (strlen($phone) !== 11 || !preg_match('/^\d+$/', $phone)) {
        wp_send_json_error("<div style='background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;'>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯</div>");
    }
    
    if (strlen($password) < 4) {
        wp_send_json_error("<div style='background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;'>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 4 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯</div>");
    }
    
    create_nobat_tables();
    
    $table_name = $wpdb->prefix . 'nobat_users';
    $existing_user = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE phone_number = %s", $phone));
    
    if ($existing_user) {
        wp_send_json_error("<div style='background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; border: 1px solid #ffeaa7;'>Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª</div>");
    }
    
    $hashed_password = wp_hash_password($password);
    
    $result = $wpdb->insert($table_name, array(
        'full_name' => $full_name,
        'phone_number' => $phone,
        'password' => $hashed_password
    ), array('%s', '%s', '%s'));
    
    if ($result) {
        $user_id = $wpdb->insert_id;
        $user = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE id = %d", $user_id));
        
        $_SESSION['nobat_user'] = array(
            'id' => $user->id,
            'full_name' => $user->full_name,
            'phone_number' => $user->phone_number
        );
        
        wp_send_json_success();
    } else {
        wp_send_json_error("<div style='background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;'>Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…! Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯</div>");
    }
}

function login_user_ajax() {
    global $wpdb;
    
    $phone = sanitize_text_field($_POST['phone_number']);
    $password = $_POST['password'];
    
    if (strlen($phone) !== 11 || !preg_match('/^\d+$/', $phone)) {
        wp_send_json_error("<div style='background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;'>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯</div>");
    }
    
    $table_name = $wpdb->prefix . 'nobat_users';
    $user = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE phone_number = %s", $phone));
    
    if ($user && wp_check_password($password, $user->password)) {
        $_SESSION['nobat_user'] = array(
            'id' => $user->id,
            'full_name' => $user->full_name,
            'phone_number' => $user->phone_number
        );
        
        wp_send_json_success();
    } else {
        wp_send_json_error("<div style='background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;'>âŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª</div>");
    }
}

function get_user_appointments_ajax() {
    global $wpdb;
    
    if (!isset($_SESSION['nobat_user'])) {
        echo "<p>Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</p>";
        wp_die();
    }
    
    $user_phone = $_SESSION['nobat_user']['phone_number'];
    $table_name = $wpdb->prefix . 'nobat_system';
    
    $appointments = $wpdb->get_results($wpdb->prepare(
        "SELECT * FROM $table_name WHERE phone_number = %s ORDER BY created_at DESC LIMIT 10",
        $user_phone
    ));
    
    if ($appointments && count($appointments) > 0) {
        $output = '<div style="display: grid; gap: 10px;">';
        foreach ($appointments as $app) {
            $status_color = $app->status == 'pending' ? '#ffc107' : 
                           ($app->status == 'in-progress' ? '#007cba' : 
                           ($app->status == 'completed' ? '#28a745' : '#dc3545'));
            $status_text = $app->status == 'pending' ? 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±' : 
                          ($app->status == 'in-progress' ? 'Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ²ÛŒØª' : 
                          ($app->status == 'completed' ? 'Ø§ØªÙ…Ø§Ù… ÛŒØ§ÙØªÙ‡' : 'Ù„ØºÙˆ Ø´Ø¯Ù‡'));
            
            $cancel_button = $app->status == 'pending' ? 
                "<button onclick='cancelAppointment({$app->id})' style='padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;'>Ù„ØºÙˆ Ù†ÙˆØ¨Øª</button>" : "";
            
            $output .= "
            <div style='border-right: 4px solid {$status_color}; padding: 12px; background: white; border-radius: 6px;'>
                <div style='display: flex; justify-content: space-between; align-items: center;'>
                    <div>
                        <strong>Ù†ÙˆØ¨Øª #{$app->position}</strong><br>
                        <small>ØªØ§Ø±ÛŒØ®: " . date('Y-m-d H:i', strtotime($app->created_at)) . "</small>
                    </div>
                    <div style='text-align: center;'>
                        <div style='color: {$status_color}; font-weight: bold; margin-bottom: 5px;'>
                            {$status_text}
                        </div>
                        {$cancel_button}
                    </div>
                </div>
            </div>";
        }
        $output .= '</div>';
    } else {
        $output = '<p style="text-align: center; color: #666;">Ù‡Ù†ÙˆØ² Ù†ÙˆØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p>';
    }
    
    echo $output;
    wp_die();
}

function add_user_appointment_ajax() {
    global $wpdb;
    
    if (!isset($_SESSION['nobat_user'])) {
        echo "<div style='background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;'>Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</div>";
        wp_die();
    }
    
    $user = $_SESSION['nobat_user'];
    $doctor = sanitize_text_field($_POST['doctor']);
    $service = sanitize_text_field($_POST['service']);
    
    create_nobat_tables();
    
    $table_name = $wpdb->prefix . 'nobat_system';
    $last_pos = $wpdb->get_var("SELECT MAX(position) FROM $table_name");
    $new_pos = $last_pos ? $last_pos + 1 : 1;
    
    $result = $wpdb->insert($table_name, array(
        'patient_name' => $user['full_name'],
        'phone_number' => $user['phone_number'],
        'status' => 'pending',
        'position' => $new_pos
    ), array('%s', '%s', '%s', '%d'));
    
    if ($result !== false) {
        echo "<div style='background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; border: 1px solid #c3e6cb;'>
                âœ… Ù†ÙˆØ¨Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!<br>
                <strong>Ø´Ù…Ø§Ø±Ù‡ Ù†ÙˆØ¨Øª: {$new_pos}</strong><br>
                <strong>Ù¾Ø²Ø´Ú©: {$doctor}</strong><br>
                <strong>Ø®Ø¯Ù…Øª: {$service}</strong>
              </div>";
    } else {
        $error_msg = $wpdb->last_error ? $wpdb->last_error : 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡';
        echo "<div style='background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;'>Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†ÙˆØ¨Øª! ({$error_msg})</div>";
    }
    
    wp_die();
}

function logout_user_ajax() {
    session_destroy();
    wp_redirect('/ÙˆØ±ÙˆØ¯/');
    exit;
}

// ==================== Ø«Ø¨Øª ØªÙˆØ§Ø¨Ø¹ Ajax ====================
add_action('wp_ajax_add_nobat', 'add_nobat_ajax');
add_action('wp_ajax_get_nobat_list', 'get_nobat_list_ajax');
add_action('wp_ajax_check_nobat_status', 'check_nobat_status_ajax');
add_action('wp_ajax_change_nobat_status', 'change_nobat_status_ajax');
add_action('wp_ajax_cancel_appointment', 'cancel_appointment_ajax');
add_action('wp_ajax_register_user', 'register_user_ajax');
add_action('wp_ajax_login_user', 'login_user_ajax');
add_action('wp_ajax_get_user_appointments', 'get_user_appointments_ajax');
add_action('wp_ajax_add_user_appointment', 'add_user_appointment_ajax');
add_action('wp_ajax_logout_user', 'logout_user_ajax');

add_action('wp_ajax_nopriv_get_nobat_list', 'get_nobat_list_ajax');
add_action('wp_ajax_nopriv_check_nobat_status', 'check_nobat_status_ajax');
add_action('wp_ajax_nopriv_register_user', 'register_user_ajax');
add_action('wp_ajax_nopriv_login_user', 'login_user_ajax');
add_action('wp_ajax_nopriv_get_user_appointments', 'get_user_appointments_ajax');
add_action('wp_ajax_nopriv_add_user_appointment', 'add_user_appointment_ajax');
add_action('wp_ajax_nopriv_logout_user', 'logout_user_ajax');
